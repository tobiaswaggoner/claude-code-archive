import {
  boolean,
  jsonb,
  pgSchema,
  text,
  timestamp,
  uuid,
} from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";

export const claudeArchiveSchema = pgSchema("claude_archive");

/**
 * Collector - Registered sync instances.
 * Each collector (per host/WSL) generates a UUID on first start and registers with the server.
 */
export const collector = claudeArchiveSchema.table("collector", {
  // PK - Generated by the collector on start, persisted locally
  id: uuid("id").primaryKey(),

  // Display name (e.g., "desktop-wsl-ubuntu")
  name: text("name").notNull(),

  // OS hostname
  hostname: text("hostname").notNull().unique(),

  // OS details (e.g., "Ubuntu 22.04 WSL2")
  osInfo: text("os_info"),

  // Collector version
  version: text("version"),

  // Active configuration (search_paths, etc.)
  config: jsonb("config"),

  // First registration timestamp
  registeredAt: timestamp("registered_at", { withTimezone: true }).notNull(),

  // Last heartbeat/sync timestamp
  lastSeenAt: timestamp("last_seen_at", { withTimezone: true }).notNull(),

  // Last sync run ID
  lastSyncRunId: uuid("last_sync_run_id"),

  // Last sync status: success, error, partial
  lastSyncStatus: text("last_sync_status"),

  // Manually deactivated?
  isActive: boolean("is_active").default(true),
});

export const collectorRelations = relations(collector, ({ many }) => ({
  runLogs: many(runLog),
}));

// Import after defining collector to avoid circular dependency
import { runLog } from "./runlog";

export type Collector = typeof collector.$inferSelect;
export type NewCollector = typeof collector.$inferInsert;
